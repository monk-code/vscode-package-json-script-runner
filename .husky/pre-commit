#!/usr/bin/env sh

echo "ğŸš€ Running pre-commit validation..."

# Count staged files for performance warning
STAGED_COUNT=$(git diff --cached --name-only | wc -l)

if [ $STAGED_COUNT -gt 50 ]; then
  echo "âš ï¸  Warning: You're committing ${STAGED_COUNT} files."
  echo "   Consider breaking this into smaller commits for better history."
  echo ""
fi

# Run lint-staged for formatting and linting on staged files
echo "ğŸ“ Running lint-staged on staged files..."
pnpm exec lint-staged

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Lint-staged validation failed!"
  echo ""
  echo "ğŸ“‹ Quick fixes:"
  echo "  â€¢ Linting errors: Run 'pnpm lint:fix' to automatically fix issues"
  echo "  â€¢ Formatting errors: Run 'pnpm format:fix' to automatically fix issues"
  echo ""
  echo "ğŸ’¡ Tip: lint-staged temporarily stashes unstaged changes while running."
  echo "   If you see unexpected behavior, check your unstaged changes."
  echo ""
  exit 1
fi

# Run type checking on the whole project (required for TypeScript)
echo "ğŸ” Running type checking..."
pnpm types:check

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Type checking failed!"
  echo ""
  echo "ğŸ“‹ To fix:"
  echo "  â€¢ Run 'pnpm types:check' to see detailed type errors"
  echo "  â€¢ Fix the type errors in your editor"
  echo ""
  echo "âš ï¸  Note: Type checking runs on the entire project, not just staged files."
  echo "   Ensure your unstaged changes don't have type errors."
  echo ""
  exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
pnpm test

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests failed!"
  echo ""
  echo "ğŸ“‹ To fix:"
  echo "  â€¢ Run 'pnpm test' to see failing tests"
  echo "  â€¢ Fix the failing tests before committing"
  echo ""
  exit 1
fi

echo ""
echo "âœ… All pre-commit checks passed!"
echo ""
echo "ğŸ’¡ For faster iteration during development, you can use:"
echo "   â€¢ 'pnpm quick-validate' - Runs only linting and formatting (fast)"
echo "   â€¢ 'pnpm validate' - Runs the full validation suite"
